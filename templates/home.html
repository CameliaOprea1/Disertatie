<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfF-hqY2s2EnowovqFi8QuvMCcRSQtDbQ&libraries=places"></script>

    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background-color: #2c2c2c;
            color: #e0e0e0;
        }

        .left-pane {
            width: 320px;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #1e1e1e;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: width 0.3s ease, left 0.3s ease;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .left-pane.collapsed {
            width: 0;
            overflow: hidden;
            padding: 20px 0;
        }

        .left-pane h4 {
            font-size: 1.5rem;
            margin-top: 20px;
            margin-bottom: 40px;
            color: #ffffff;
            text-align: center;
        }

        .left-pane .input-group {
            margin-bottom: 30px;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .left-pane .input-group-text {
            background-color: #32CD32;
            color: #333;
            border: none;
            border-radius: 8px 0 0 8px;
            padding: 10px 15px;
        }

        .left-pane .form-control {
            background-color: #333;
            color: #e0e0e0;
            border: none;
            border-radius: 0 8px 8px 0;
            width: 100%;
            padding: 10px;
        }

        .btn-primary {
            background-color: #32CD32;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #32CD32;
        }

        .map-container {
            height: 100%;
            margin-left: 320px;
            transition: margin-left 0.3s ease;
        }

        .left-pane.collapsed + .map-container {
            margin-left: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #togglePanelBtn {
            position: fixed;
            top: 20px;
            left: 320px;
            z-index: 1001;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: left 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #togglePanelBtn:hover {
            background-color: #32CD32;
        }

        .left-pane.collapsed ~ #togglePanelBtn {
            left: 20px;
            transform: rotate(180deg);
        }

        #loadingSpinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #32CD32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingMessage {
            display: none;
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: #fff;
        }

        #routeResult {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: #e0e0e0; /* Match the text color of the app */
            font-family: 'Roboto', sans-serif;
        }

        #routeResult p {
            margin: 10px 0;
        }

        #routeResult .route-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        #routeResult .route-info .icon {
            background-color: #32CD32;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1rem;

        }

        #routeResult .route-info .time,
        #routeResult .route-info .arrival {
            font-size: 1rem; /* Match the font size */
            color: #ccc;
        }
        #routeResult .route-info .details .duration {
            font-size: 1.4rem; /* Slightly larger for emphasis */
            color: #32CD32; /* Highlight with green color */
            
        }
        
        #routeResult .route-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #routeResult .route-details .detail {
            display: flex;
            align-items: center;
            font-size: 1rem; /* Match the font size */
        }
        
        #routeResult .route-details .detail i {
            color: #32CD32;
            margin-right: 10px;
            min-width: 20px; /* Ensure consistent alignment */
            display: flex;
            align-items: center;
            justify-content: center;

        }

        #routeResult {
            display: none; /* Hide by default */
        }

        #routeResult.show {
            display: block; /* Show when the show class is added */
        }

        #routeResult .route-details .detail .label {
            margin-right: 5px;
        }

        #routeResult .route-details .detail .value {
            color: #ccc;
        }

        .traffic-predictor-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #32CD32;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            z-index: 1001;
            margin-left: 10px; /* Add some space between the buttons */
        }

        .traffic-predictor-btn:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }

        .traffic-predictor-btn i {
            font-size: 1.5rem;
            color: #fff;
        }

        /* Adjust positions to align buttons next to each other */
        #retrainModelBtn {
            right: 180px; /* Adjust this value based on the button width and spacing */
        }

        #roadCategoryBtn {
            right: 100px;
        }
        
        #resultTypeBtn {
            right: 20px;
        }

        #retrainModelBtn i, #roadCategoryBtn i, #resultTypeBtn i {
        color: #1e1e1e;
        }

        .options {
            display: none;
            position: fixed;
            top: 90px;
            right: 20px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            width: 250px;
            overflow: hidden; /* Ensure smooth height transition */
            transition: height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            height: 0;
        }

        .options.show {
            display: block;
            opacity: 1;
            height: auto; /* Set a fixed height suitable for the content */
        }

        .options:not(.show) {
            opacity: 0;
            height: 0;
        }

        .options label {
            color: #fff;
            width: 100%;
            display: block;
            text-align: center;
            font-weight: 500;
        }
        .options select, .options button {
            color: #fff;
            width: 100%;
            display: block;
        }

        .options select {
            margin-top: 10px;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            background-color: #333;
            color: #fff;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        

        .options select option {
            background-color: #333;
            color: #fff;
        }

        /* Hover effect for the select element (not the options) */
        .options select:hover {
            background-color: #444;
        }

        .options button {
            margin-top: 20px;
            padding: 10px;
            font-size: 1rem;
            background: #32CD32;
            color: #000; /* Change text color to black */
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            text-align: center;
            line-height: 1.5; /* Ensure vertical centering */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .options button:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .options .btn-category {
            margin-top: 20px;
            padding: 10px;
            font-size: 1rem;
            background: linear-gradient(135deg, #212325, #212325);
            color: #fff;
            border: none;
            border-radius: 8px;
            text-align: center;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .options .btn-category:hover {
            background: linear-gradient(135deg, #212325, #212325);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #roadCategoryModal .modal-content {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border-radius: 12px;
        }

        /* Reset select and option styles for cross-browser consistency */
        select, select:focus, select:active, select:hover {
            background-color: #333 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            border-radius: 8px !important;
            padding: 10px !important;
            font-size: 1rem !important;
        }

        option, option:focus, option:active, option:hover {
            background-color: #333 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            padding: 10px !important;
            font-size: 1rem !important;
        }



        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #fff !important;
            background-color: #333 !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 10px !important;
            font-size: 1rem !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            color: #fff !important;
        }


        #roadCategoryModal .modal-header,
        #roadCategoryModal .modal-footer {
            border: none;
        }

        @media (max-width: 768px) {
            .left-pane {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
            }

            .left-pane.collapsed {
                width: 0;
                height: 0;
                padding: 0;
            }

            .map-container {
                margin-left: 0;
            }

            #togglePanelBtn {
                left: 20px;
                top: 80px;
            }

            .left-pane.collapsed ~ #togglePanelBtn {
                left: 20px;
                top: 20px;
                transform: rotate(180deg);
            }

            .traffic-predictor-btn {
                bottom: 20px;
                right: 20px;
            }

            .options {
                top: auto;
                bottom: 90px;
                right: 20px;
            }

        }
        #clock {
                font-size: 1.4rem;
                background-color: #1e1e1e;
                padding: 18px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
                color: #32CD32;
                margin-top: 20px;
                width: 100%;
                text-align: center;
                letter-spacing: 3px;
            }

        #clock .day {
            font-size: 1rem;
            color: #e0e0e0;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="left-pane" id="leftPane">
        <div>
            <h4>Where to?</h4>
            <form id="routeForm">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    <input class="form-control" type="text" placeholder="Start Location" id="start">
                </div>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    <input class="form-control" type="text" placeholder="End Location" id="end">
                </div>
                <button class="btn btn-primary" type="button" onclick="getRoute()">Get Route</button>
            </form>
            <div id="routeResult"></div>
        </div>
        <div id="clock"></div>
    </div>
    <button id="togglePanelBtn">
        <i class="fas fa-chevron-left"></i>
    </button>
    <div class="map-container">
        <div id="map">
            {{ map_html|safe }}
        </div>
    </div>
    <div id="loadingSpinner"></div>
    <div id="loadingMessage">Fetching route, please wait...</div>
    <button class="traffic-predictor-btn" id="retrainModelBtn">
        <i class="material-icons" style="font-size:36px">toc</i>
    </button>

    <button class="traffic-predictor-btn" id="roadCategoryBtn">
        <i class="fas fa-road"></i>
    </button>
    
    <button class="traffic-predictor-btn" id="resultTypeBtn">
        <i class="fas fa-cogs"></i>
    </button>

    <div id="retrainOptions" class="options">
        <form id="predictorForm">
            <label for="retrainSelect" class="form-label">Select Retrain Period for Congestion</label>
            <select class="form-select" id="retrainSelect">
                <option value="whole">Entire data</option>
                <option value="last_week">Last week</option>
                <option value="last_2_weeks">Last 2 weeks</option>
            </select>
        </form>
    </div>

    <div id="roadOptions" class="options">
        <form id="roadTypeForm">
            <label for="roadSelect" class="form-label">Road Category</label>
            <select class="form-select" id="roadSelect">
                <option value="all_roads">All Roads</option>
                <option value="biased">Main Roads</option>
            </select>
        </form>
    </div>

    <div id="resultOptions" class="options">
        <form id="resultTypeForm">
            <label for="resultSelect" class="form-label">Result Type</label>
            <select class="form-select" id="resultSelect">
                <option value="fastest">Fastest</option>
                <option value="optimal">Optimal</option>
                <option value="extensive">Computationally Extensive</option>
            </select>
        </form>
    </div>

    <script>

        function updateClock() {
                var now = new Date();
                var hours = now.getHours();
                var minutes = now.getMinutes().toString().padStart(2, '0');
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                var dayName = days[now.getDay()];
        
                var timeString = hours + ':' + minutes + ' ' + ampm;
                var dayString = dayName;
        
                document.getElementById('clock').innerHTML = `
                    <div class="time">${timeString}</div>
                    <div class="day">${dayString}</div>
                `;
            }

        setInterval(updateClock, 1000);
        updateClock();

        document.getElementById('togglePanelBtn').addEventListener('click', function () {
            var leftPane = document.getElementById('leftPane');
            var mapContainer = document.querySelector('.map-container');
            if (leftPane.classList.contains('collapsed')) {
                leftPane.classList.remove('collapsed');
                mapContainer.style.marginLeft = '320px';
                this.innerHTML = '<i class="fas fa-chevron-left"></i>';
                this.style.left = '320px';
            } else {
                leftPane.classList.add('collapsed');
                mapContainer.style.marginLeft = '0';
                this.innerHTML = '<i class="fas fa-chevron-right"></i>';
                this.style.left = '20px';
            }
        });

        document.getElementById('retrainModelBtn').addEventListener('click', function () {
            toggleOptions('retrainOptions');
        });

        document.getElementById('roadCategoryBtn').addEventListener('click', function () {
            toggleOptions('roadOptions');
        });
        
        document.getElementById('resultTypeBtn').addEventListener('click', function () {
            toggleOptions('resultOptions');
        });

        function formatTime(seconds) {
            // Convert seconds to minutes and round to the nearest integer
            const minutes = Math.round(seconds / 60);

            return `${minutes} min`;
        }

        function formatDistance(distance) {
            // Round distance to one decimal place
            const roundedDistance = distance.toFixed(1);
            return `${roundedDistance} km`;
        }

        function formatCongestionLevel(level) {
            let description;
            let color;
            let icon;

            switch(level) {
                case 'Low':
                    description = 'Low Congestion';
                    color = 'green';
                    icon = '✅'; // Green checkmark
                    break;
                case 'Moderate':
                    description = 'Moderate Congestion';
                    color = 'yellow';
                    icon = '⚠️'; // Yellow warning
                    break;
                case 'High':
                    description = 'High Congestion';
                    color = 'orange';
                    icon = '❌'; // Orange diamond
                    break;
                default:
                    description = 'Unknown Congestion Level';
                    color = 'grey';
                    icon = '❓'; // Grey question mark
                    break;
            }

            return `<span style="color: ${color};">${icon} ${description}</span>`;
        }

        
        
        function getRoute() {
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            var trainingPeriod = document.getElementById('retrainSelect').value;
            var road_type = document.getElementById('roadSelect').value;
            var result_type = document.getElementById('resultSelect').value;

            if (!start || !end) {
                alert('Please enter both start and end locations');
                return;
            }

            // Hide the routeResult div initially
            console.log('Hiding routeResult div initially');
            document.getElementById('routeResult').classList.remove('show');

            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'block';

            fetch('/route/get_route/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({start: start, end: end, training_period: trainingPeriod, road_type:road_type, result_type:result_type})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';

                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('map').innerHTML = data.map_html;
                    // Calculate arrival time
                    var currentTime = new Date();
                    var duration = data.duration * 1000; // duration is assumed to be in seconds
                    var arrivalTime = new Date(currentTime.getTime() + duration);
                    var arrivalHours = arrivalTime.getHours();
                    var arrivalMinutes = arrivalTime.getMinutes().toString().padStart(2, '0');
                    var arrivalAmPm = arrivalHours >= 12 ? 'PM' : 'AM';
                    arrivalHours = arrivalHours % 12;
                    arrivalHours = arrivalHours ? arrivalHours : 12; // the hour '0' should be '12'
                    var arrivalTimeString = arrivalHours + ':' + arrivalMinutes + ' ' + arrivalAmPm;

                    document.getElementById('routeResult').innerHTML = `
                    <div class="route-info">
                        <div class="details">
                            <div class="duration">${formatTime(data.duration)}</div>
                            <div class="arrival">Arrive at ${arrivalTimeString}</div>
                        </div>
                    </div>
                    <div class="route-details">
                        <div class="detail">
                            <i class="fas fa-road"></i>
                            <span class="label">Distance:</span>
                            <span class="value">${formatDistance(data.distance)}</span>
                        </div>
                        <div class="detail">
                            <i class="fas fa-traffic-light"></i>
                            <span class="label">Congestion Level:</span>
                            <span class="value">${data.congestion_level}</span>
                        </div>
                    </div>
                    `;
                    console.log('Showing routeResult div with the fetched results');
                    // Show the routeResult div with the fetched results
                    document.getElementById('routeResult').classList.add('show');
                }
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
                alert('An error occurred while fetching the route. Please try again.');
                console.error('Error:', error);
            });
        }

        function initAutocomplete() {
            var startInput = document.getElementById('start');
            var endInput = document.getElementById('end');
            var options = {
                types: ['geocode']
            };

            var startAutocomplete = new google.maps.places.Autocomplete(startInput, options);
            var endAutocomplete = new google.maps.places.Autocomplete(endInput, options);
        }

        function toggleOptions(optionsId) {
            var optionsDivs = document.querySelectorAll('.options');
            optionsDivs.forEach(div => {
                if (div.id === optionsId) {
                    if (div.classList.contains('show')) {
                        div.classList.remove('show');
                        setTimeout(() => {
                            div.style.display = 'none'; // Hide after transition
                        }, 300);
                    } else {
                        div.style.display = 'block';
                        setTimeout(() => {
                            div.classList.add('show');
                        }, 10); // Small timeout to allow display change to take effect
                    }
                } else {
                    div.classList.remove('show');
                    setTimeout(() => {
                        div.style.display = 'none';
                    }, 300);
                }
            });
        }

        function selectRoadCategory() {
            var selectedCategory = document.getElementById('roadSelect').value;
            alert('Selected Road Category: ' + selectedCategory);
            // You can add code here to use the selected road category for your route planning logic
        }
        
        function selectResultType() {
            var selectedResultType = document.getElementById('resultSelect').value;
            alert('Selected Result Type: ' + selectedResultType);
            // You can add code here to use the selected result type for your route planning logic
        }

        function retrainModel() {
            var retrainOption = document.getElementById('retrainSelect').value;

            fetch('/retrain_model/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({option: retrainOption})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Model retrained successfully!');
                } else {
                    alert('Failed to retrain model.');
                }
            })
            .catch(error => {
                alert('An error occurred while retraining the model. Please try again.');
                console.error('Error:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            initAutocomplete();
        });


        $(document).ready(function() {
        $('#retrainSelect, #roadSelect, #resultSelect').select2({
            dropdownCssClass: 'custom-select2-dropdown',
            selectionCssClass: 'custom-select2-selection'
        });
        });
        
    </script>
</body>
</html>
